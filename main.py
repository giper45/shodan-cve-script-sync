import shodan
import os
import sys, getopt
import json
import csv
import time

SHODAN_API_KEY = os.environ['SHODAN_API_KEY']
ip_target = '213.215.135.195'
def usage():
    print('{} -i <list_ip>'.format(sys.argv[0]))
    sys.exit(2)


try:
    opts, args = getopt.getopt(sys.argv[1:], 'i:')
    inputfile = ""
    for opt, arg in opts:
        if opt == '-h':
            usage()
        elif opt in ("-i"):
            inputfile = arg
    if inputfile == "":
        usage()
    print("[+] Read inputfile: {}".format(inputfile))
    with open(inputfile) as list_ip_f:
        ips= list_ip_f.readlines()
    with open('output.csv', 'w') as csvfile:
        fieldnames= ["ip", "port", "info", "cve", "cvss", "summary", "verified", "references"]
        csv_writer = csv.writer(csvfile, delimiter=";")
        csv_writer.writerow(fieldnames)
        for ip_target in ips:
            try:
                print("[+] Query {}".format(ip_target))
                time.sleep(1)
                api = shodan.Shodan(SHODAN_API_KEY)
                host = api.host(ip_target)
                data_host = host["data"]
                for d in data_host:
                    info= d["info"] if "info" in d else ""
                    vulns= d["vulns"] if "vulns" in d else {}
                    port= d["port"]
                    # host, port, info, cve-x, references, cvss, verified, summary
                    for cve, cve_info in vulns.items():
                        csv_writer.writerow([ip_target, port, info, cve, cve_info["cvss"], cve_info["summary"], cve_info["verified"], "\n".join(cve_info["references"])])
            except shodan.APIError as e:
                print('Error: {}'.format(e))

except getopt.GetoptError:
    usage()


